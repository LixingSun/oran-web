# C4架构模型

## 概述

[C4架构模型](https://c4model.com/)是一个出色的系统架构可视化框架，无论其复杂程度如何。它易于上手且对技术和非技术利益相关者都容易理解。通过将系统分解为四个层次——**上下文（Context）**、**容器（Container）**、**组件（Component）**和**代码（Code）**，C4模型可以让每个人都保持对整个系统有着清晰全面的理解。

我在过去的项目中多次应用了C4模型，并对整个团队起到了显著的帮助。考虑到高效性通常我们会更多专注于上下文和容器层次，我也将在下面分享到一些相关经验。而对于组件和代码层次，如果感兴趣的话可以访问[官方网站](https://c4model.com/)来获取更多信息。

## 上下文(Context)

C4模型中的上下文层次提供了对整个项目甚至更广泛范围的清晰且全面的概述。它让我们能够轻松快速地理解：谁是用户，涉及哪些相关系统以及它们之间的关系。

作为C4模型中的最高层次，上下文应该始终关注全局，确保它对所有人都是易于理解的，其中包括非技术人员。这个层次对于项目启动阶段、提供系统的全景视图以及促进不同受众之间的有效沟通都至关重要。

### 示例

![上下文层次示例图](https://cdn.oran.zone/blogs/c4_example_context.png)

假设我们正在创建一个公司的官方门户网站。该网站的主要功能包括展示一些公司的信息并通过短信和电子邮件向注册用户提供通知。

在上下文层次，我们首先识别到以下关键元素：

- **人员**: 与系统相关的主要用户是网站访问者，包含潜在注册用户和已注册用户
- **系统**: 在这个例子中，主要系统即是该门户网站
- **外部系统**: 为了实现短信和电子邮件通知，我们假设由相应的服务提供商作为外部系统来提供

识别出这些元素后,我们现在可以进一步标明他们之间的**关系**，例如：

- 网站访问者访问门户网站来浏览关于公司的信息，或者注册成为用户来获得通知
- 门户网站向短信和电子邮件服务提供商发送请求，来进一步向注册用户推送通知

通过连接这些元素，我们可以清晰地描绘出用户如何与系统交互，以及系统如何依赖外部服务来完成其功能。这种高层次的图表提供了一个清晰的全局视图，让技术和非技术人员都能轻松理解系统的整体架构和交互。

## 容器（Container）

容器层次将进一步深入系统内部，展示组成系统的基本元素。这些元素可以是前端应用、后端服务或数据库，只要它们是可独立运行、部署的单元。

与上下文层次相比，容器层次开始展示系统内部的更多细节，包括每个容器所使用的技术以及它们之间的通信方式，但仍保留了如何与人员及外部系统交互的相关信息。

虽然它仍然是一个高层次的图表，但它为具有一些技术背景的人提供了更多的信息。这种程度的细节可以帮助在高层概览和底层设计之间架起桥梁，在兼顾了为技术相关干系人提供更全面信息的同时，也保留了对非技术人员的可读性。

### 示例

![容器层次示例图](https://cdn.oran.zone/blogs/c4_example_container.png)

我们使用上下文部分使用到的示例。假设我们的架构由一个前端单页应用（SPA），一个提供必要功能的API后端应用，一个独立负责通知功能的通知服务以及一个存储系统所有信息的数据库组成。


我们可以通过以下步骤来构建容器层次图：

1. **基于上下文**: 保留用户和外部系统，并用一个空的系统范围边界替换当前系统元素。

2. **添加容器**: 在刚创建的系统范围边界内，根据我们假设的架构逐一添加容器，并提供它们的相关信息，如简短描述和所用技术. 

3. **创建关系**: 添加容器之间是如何交互的。例如，前端单页面应用通过发送HTTP请求来和后端API应用进行交互，而后端则会向数据库读取或者存储数据。

4. **完善外部交互s**: 更新与人员及外部系统的交互来反应新的细节. 例如用户会通过浏览器访问前端单页面应用来浏览信息或者完成注册，而独立的通知服务会通过发送HTTP请求的方式与外部通过服务提供商进行交互。

在完成所有这些步骤之后，我们就有了一个完整的容器层次图。它清楚展示了高层次架构，并提供了有用的技术信息。对于项目相关的所有人特别是技术相关干系人都提供了很高的价值。

## 实用技巧

- **绘图工具**: 我强烈推荐使用[draw.io](https://www.drawio.com/) 来创建C4图表。它既有网页版也有免费下载的应用，其丰富的元素类型中包含了现成的C4标准元素，使得绘制C4时非常方便。此外你也能在网上找到很多其他工具。
- **从上下文开始**: 建议始终从大局出发由创建上下文层次开始，特别是在整理一些现成项目或者遗留项目的时候。自上而下的方式有助于在深入研究各个服务或代码组件之间的复杂关系之前理解整体架构，避免在过早阶段就被细节所淹没。
- **避免交叉箭头**: 随着图表复杂性增加，特别是在较低层次，常会出现代表关系的箭头交叉的情况。为提高整体表达的清晰程度，建议重新摆放容器位置，优化线路，尽量减少交叉的箭头。这样可以显著降低新查看者在理解系统关系时的认知负载。
- **一致的命名和描述**: 对图中的所有元素使用清晰且一致的命名和描述。这有助于使所有相关者更容易理解图表中的组件及其在系统中的角色。
- **迭代式改进**: 一定记住持续迭代更新项目中的C4模型。随着收集到更多反馈，或架构的演变，图表需要持续更新来更好地呈现系统。这样可以确保该图表随着时间的推移保持准确有用。

## 延展阅读

- [C4模型官方网站](https://c4model.com/)
- [Simon Brown - C4模型作者](https://simonbrown.je/)
- [InfoQ | The C4 Model for Software Architecture](https://www.infoq.com/articles/C4-architecture-model/)